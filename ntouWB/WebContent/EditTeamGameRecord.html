<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"> 
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>NTOUWB</title>
		<link rel="Shortcut Icon" type="image/x-icon" href="img/icon.ico">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<link rel="stylesheet" type="text/css" href="css/frame.css" />
	</head>
	<body>
		<div class="container-fluid">
			<div class="col-md-2"></div>
			<div class="col-md-8">
				<div class="row" id="title"></div>
				<div class="row" id="menu"></div>
				<div class="row">
				<!-- 內容 -->
<!-- ==================================================================================================================================== -->
					<div class="col-md-12">
						<div class="btn-group">
							<button type="button" class="btn btn-darkBlue" onclick="location.href='TeamGameRecord.html'">檢視模式</button>
							<button type="button" class="btn btn-darkBlue active" onclick="location.href='EditTeamGameRecord.html'">編輯模式</button>
						</div>
						<button type="button" class="btn btn-darkBlue btn-sm" style="float: right;" onclick="saveAll();">儲存</button>
					</div>
					<div class="col-md-12" style="margin-top: 3vh;">
						<table class="table table-hover table-bordered" style="border-color: #ce5656;">
							<thead>
								<tr>
									<th style="border-color: #ce5656; background-color: #ce5656; color: white;">場次</th>
									<th style="border-color: #ce5656; background-color: #ce5656; color: white;">日期</th>
									<th style="border-color: #ce5656; background-color: #ce5656; color: white;">對手</th>
									<th style="border-color: #ce5656; background-color: #ce5656; color: white;">比分</th>
									<th style="border-color: #ce5656; background-color: #ce5656; color: white;">結果</th>
									<th style="border-color: #ce5656; background-color: #ce5656; color: white;"></th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td style="border-color: #ce5656;" id="gameID">2</td>
									<td class="col-md-2" style="border-color: #ce5656;">
										<input type="date" class="form-control" placeholder="比賽日期" id="date" />
									</td>
									<td class="col-md-2" style="border-color: #ce5656;">
										<input type="text" class="form-control" placeholder="對手" id="opponent" />
									</td>
									<td class="form-inline" style="border-color: #ce5656;">
										<input type="number" min="0" class="form-control" placeholder="海大比分" id="ourPoint" />
										：
										<input type="number" min="0" class="form-control" placeholder="對手比分" id="opponentPoint" />
									</td>
									<td class="col-md-1" style="border-color: #ce5656;">
										<select class="form-control" id="resultSelect">
											<option value="win">贏</option>
											<option value="lose">輸</option>
										</select>
									</td>
									<td class="col-md-1" style="border-color: #ce5656;">
										<button type="button" class="btn btn-darkBlue btn-sm" onclick="deleteALL();">刪除</button>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="col-md-12">
						<div class="panel panel-default" style="border-color: #ce5656; border-radius: 0;">
							<div class="panel-heading" id="listHeading" style="background-color: #ce5656; color: white; border-radius: 0;">
								本場球員數據
							</div>
							<div class="panel-body">
								<table id="teamGameRecord" class="table table-hover" style="border-color: #ce5656;">
										<thead>
											<tr>
												<th class="col-md-2" style="border-color: #ce5656;">姓名</th>
												<th style="border-color: #ce5656;">二分<br>進球/出手</th>
												<th style="border-color: #ce5656;">三分<br>進球/出手</th>
												<th style="border-color: #ce5656;">罰球<br>進球/出手</th>
												<th style="border-color: #ce5656;">抄截</th>
												<th style="border-color: #ce5656;">籃板</th>
												<th style="border-color: #ce5656;">助攻</th>
												<th style="border-color: #ce5656;">失誤</th>
												<th style="border-color: #ce5656;">犯規</th>
												<th style="border-color: #ce5656;"></th>
											</tr>
										</thead>
										<tbody id="teamGameRecordTBody"></tbody>
								</table>
								<button type="button" class="btn btn-darkBlue btn-sm" style="float: right;" onclick="newRow();">新增</button>
							</div>
						</div>
					</div>
<!-- ==================================================================================================================================== -->
				</div>
			</div>
			<div class="col-md-2"></div>
		</div>
		<div id="deleteModal" class="modal fade" role="dialog">
			<div class="modal-dialog modal-sm">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">提醒</h4>
					</div>
					<div class="modal-body">
						<p id="noticeContent">你確定要刪除本場比賽全部資料嗎？</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-danger" data-dismiss="modal" onclick="sureToDeleteAll();">確定</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
					</div>
				</div>
			</div>
		</div>
		<div id="noticeModal" class="modal fade" role="dialog">
			<div class="modal-dialog modal-sm">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">提醒</h4>
					</div>
					<div class="modal-body">
						<p id="noticeContent">不能以空白儲存<br>請檢查！</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-darkBlue" data-dismiss="modal">確定</button>
					</div>
				</div>
			</div>
		</div>
		<!-- 框架 -->
		<script src="js/frame.js"></script>
		<!-- 身份判斷 -->
		<script>
			$(document).ready(function() {
				$.ajax({
					type: "POST",
					url: "GameRecordServlet",
					data: {
						option: "checkIdentity"
					},
					dataType: "text",
					success: function(response) {
						if(response == "general" || response == "graduated") {
							location.href = "TeamGameRecord.html";
						}
					},
					error: function() {
						console.log("checkIdentity error\n");
					}
				});
			});
		</script>
		<script>
		var rowNumber = 0;
		var rowCount = 0;
		var originMember = 0;
		var addMember = 0;
		$(document).ready(function() {
			getTeamGameRecord();
		});
		function getTeamGameRecord() {
			/*取得某場次比賽數據*/
			$.ajax({
				type: "POST",
				url: "GameRecordServlet",
				data: {
					option: "getTeamGameRecord"
				},
				dataType: "json",
				success: function(response) {
					$("#gameID").html(response.gameID);
					$("#date").val(response.date);
					$("#opponent").val(response.opponent);
					$("#ourPoint").val(response.ourPoint);
					$("#opponentPoint").val(response.opponentPoint);
					if(response.result == "輸") {
						$('#resultSelect option[value=lose]').attr('selected', 'selected');
					}
					$("#teamGameRecordTBody").empty();
					for(var i=0; i<response.MGR.length; i++) {
						$("#teamGameRecordTBody").append(
"											<tr id='row" + rowNumber + "'>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + response.MGR[i].name + "</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='進球' value='" + response.MGR[i].game_2PM + "' />" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='出手' value='" + response.MGR[i].game_2PA + "' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='進球' value='" + response.MGR[i].game_3PM + "' />" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='出手' value='" + response.MGR[i].game_3PA + "' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='進球' value='" + response.MGR[i].game_FTM + "' />" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='出手' value='" + response.MGR[i].game_FTA + "' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' placeholder='抄截' value='" + response.MGR[i].game_STL + "' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' placeholder='籃板' value='" + response.MGR[i].game_RB + "' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' placeholder='助攻' value='" + response.MGR[i].game_AST + "' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' placeholder='失誤' value='" + response.MGR[i].game_TO + "' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' placeholder='犯規' value='" + response.MGR[i].game_FOUL + "' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<button type='button' class='btn btn-darkBlue btn-sm' style='float: right;' onclick='deleteRow(\"" + rowNumber + "\");'>刪除</button>" + "\n" + 
"												</td>" + "\n" + 
"											</tr>" + "\n");
						rowNumber++;
						rowCount++;
						originMember++;
					}
					/*表格排序*/
					$("#teamGameRecord").trigger("update");
					//$("#teamGameRecord").trigger("sorton", [ [[0,0]] ]);
				},
				error: function() {
					console.log("getTeamGameRecord error\n");
				}
			});
		}
		/*新增row*/
		function newRow() {
			var optionCode = "";
			$.ajax({
				type: "POST",
				url: "GameRecordServlet",
				data: {
					option: "getMemberList"
				},
				dataType: "json",
				async: false,
				success: function(response) {
					for(var i=0; i<response.length; i++) {
						optionCode += "														<option>" + response[i].name + "</option>\n";
					}
				},
				error: function() {
					console.log("getMemberList error\n");
				}
			});
			$("#teamGameRecordTBody").append(
"											<tr id='row" + rowNumber + "'>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<select class='form-control' id='nameSelect'>" + "\n" + 
														optionCode + 
"													</select>" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='進球' />" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='出手' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='進球' />" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='出手' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='進球' />" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' style='margin-bottom: 1vh;' placeholder='出手' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' placeholder='抄截' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' placeholder='籃板' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' placeholder='助攻' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' placeholder='失誤' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<input type='number' min='0' class='form-control input-sm' placeholder='犯規' />" + "\n" + 
"												</td>" + "\n" + 
"												<td style='border-color: #ce5656;'>" + "\n" + 
"													<button type='button' class='btn btn-darkBlue btn-sm' onclick='deleteRow(\"" + rowNumber + "\");'>刪除</button>" + "\n" + 
"												</td>" + "\n" + 
"											</tr>");
			rowNumber++;
			rowCount++;
			addMember++;
		}
		/*刪除row*/
		function deleteRow(number) {
			$("#row" + number).remove();
			rowCount--;
			if(number < originMember) originMember--;
			else addMember--;
		}
		/*刪除全部(跳出提醒視窗)*/
		function deleteALL() {
			$("#deleteModal").modal("show");
		}
		/*確定要刪除全部*/
		function sureToDeleteAll() {
			$.ajax({
				type: "POST",
				url: "GameRecordServlet",
				data: {
					option: "deleteAllGameRecord"
				},
				dataType: "text",
				success: function(response) {
					location.href = "TeamGameRecordList.html";
				},
				error: function() {
					console.log("sureToDeleteAll error\n");
				}
			});
		}
		/*儲存全部*/
		function saveAll() {
			if(!checkBeforeSave()) return;
			var gameRecordData = "{\"gameID\":\"" + $("#gameID").html() + "\",\"date\":\"" + $("#date").val() + "\",\"opponent\":\"" + $("#opponent").val() + "\",\"score\":\"" + $("#ourPoint").val() + ":"+ $("#opponentPoint").val() + "\",\"result\":\"" + $('#resultSelect :selected').text() + "\",\"MGR\":[";
			for(var i=0; i<rowCount; i++) {
				var temp = "{";
				if(i < originMember) {
					temp += "\"name\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(0)").html() + "\",";
				}
				else {
					temp += "\"name\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(0) > #nameSelect :selected").text() + "\",";
				}
				temp += "\"game_2PM\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(1) > input:first").val() + "\",";
				temp += "\"game_2PA\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(1) > input:last").val() + "\",";
				temp += "\"game_3PM\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(2) > input:first").val() + "\",";
				temp += "\"game_3PA\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(2) > input:last").val() + "\",";
				temp += "\"game_FTM\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(3) > input:first").val() + "\",";
				temp += "\"game_FTA\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(3) > input:last").val() + "\",";
				temp += "\"game_STL\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(4) > input:last").val() + "\",";
				temp += "\"game_RB\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(5) > input:last").val() + "\",";
				temp += "\"game_AST\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(6) > input:last").val() + "\",";
				temp += "\"game_TO\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(7) > input:last").val() + "\",";
				temp += "\"game_FOUL\":\"" + $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(8) > input:last").val() + "\"}";
				if(i == 0) {
					gameRecordData += temp;
				}
				else {
					gameRecordData += "," + temp;
				}
			}
			gameRecordData += "]}";
			//console.log(gameRecordData);
			$.ajax({
				type: "POST",
				url: "GameRecordServlet",
				data: {
					option: "saveAllGameRecord",
					gameRecordData: gameRecordData
				},
				dataType: "text",
				success: function(response) {
					location.href = "TeamGameRecord.html";
				},
				error: function() {
					console.log("saveAll error\n");
				}
			});
		}
		/*檢查空白*/
		function checkBeforeSave() {
			for(var i=0; i<rowCount; i++) {
				if($("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(1) > input:first").val() == "" || $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(1) > input:last").val() == "" || $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(2) > input:first").val() == "" || $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(2) > input:last").val() == "" || $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(3) > input:first").val() == "" || $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(3) > input:last").val() == "" || $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(4) > input:last").val() == "" || $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(5) > input:last").val() == "" || $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(6) > input:last").val() == "" || $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(7) > input:last").val() == "" || $("#teamGameRecordTBody > tr:eq(" + i + ") > td:eq(8) > input:last").val() == "") {
					$("#noticeModal").modal("show");
					return false;
				}
			}
			if($("#date").val() == "" || $("#opponent").val() == "" || $("#ourPoint").val() == "" || $("#opponentPoint").val() == "") {
				$("#noticeModal").modal("show");
				return false;
			}
			else return true;
		}
		</script>
	</body>
</html>